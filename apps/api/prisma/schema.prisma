// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  profile   Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  analyses               Analysis[]
  meals                  Meal[]
  media                  Media[]
  mealLogs               MealLog[]
  refreshTokens          RefreshToken[]
  otps                   Otp[]
  magicLinks             MagicLink[]
  userProfile            UserProfile?
  aiAssistant            AiAssistant[]
  pushTokens             PushToken[]
  notificationPreference NotificationPreference?

  @@map("users")
}

model UserProfile {
  id                    String   @id @default(cuid())
  userId                String   @unique
  firstName             String?
  lastName              String?
  age                   Int?
  height                Float? // in cm
  weight                Float? // in kg
  gender                String? // male, female, other
  activityLevel         String? // sedentary, lightly_active, moderately_active, very_active, extremely_active
  goal                  String? // lose_weight, maintain_weight, gain_weight
  targetWeight          Float?
  dailyCalories         Int?
  preferences           Json? // dietary preferences, allergies, etc.
  isOnboardingCompleted Boolean  @default(false)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_profiles")
}

model Analysis {
  id        String   @id @default(cuid())
  userId    String
  type      String // IMAGE, TEXT
  status    String // PENDING, PROCESSING, COMPLETED, FAILED
  metadata  Json?
  error     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user    User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  results AnalysisResult[]

  @@map("analyses")
}

model AnalysisResult {
  id         String   @id @default(cuid())
  analysisId String
  data       Json
  createdAt  DateTime @default(now())

  // Relations
  analysis Analysis @relation(fields: [analysisId], references: [id], onDelete: Cascade)

  @@map("analysis_results")
}

model Meal {
  id             String    @id @default(cuid())
  userId         String
  name           String
  type           String
  consumedAt     DateTime?
  healthScore    Float?    @map("health_score")
  healthGrade    String?   @map("health_grade")
  healthInsights Json?     @map("health_insights")
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  user  User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items MealItem[]

  @@map("meals")
}

model MealItem {
  id       String @id @default(cuid())
  mealId   String
  name     String
  calories Float
  protein  Float
  fat      Float
  carbs    Float
  weight   Float?

  // Relations
  meal Meal @relation(fields: [mealId], references: [id], onDelete: Cascade)

  @@map("meal_items")
}

enum MealLogMealType {
  BREAKFAST
  LUNCH
  DINNER
}

model MealLog {
  id        String          @id @default(cuid())
  userId    String
  mealType  MealLogMealType
  fdcId     String?
  label     String
  quantity  Float?
  unit      String?
  calories  Float?
  protein   Float?
  fat       Float?
  carbs     Float?
  createdAt DateTime        @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([fdcId])
  @@map("meal_logs")
}

model Media {
  id              String   @id @default(cuid())
  userId          String
  filename        String
  mimetype        String
  size            Int
  data            Bytes?
  storageKey      String?
  storageBucket   String?
  storageProvider String?  @default("database")
  createdAt       DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@map("media")
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  jti       String? // JWT ID for blacklisting
  revoked   Boolean  @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

model Otp {
  id        String   @id @default(cuid())
  userId    String
  code      String
  secret    String
  used      Boolean  @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("otps")
}

model MagicLink {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  email     String
  used      Boolean  @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([email])
  @@map("magic_links")
}

model AiAssistant {
  id               String   @id @default(cuid())
  userId           String
  type             String // nutrition_advice, health_check, general_question
  question         String
  answer           String
  context          Json? // additional context for the conversation
  tokensUsed       Int? // Total tokens used for this request
  promptTokens     Int? // Prompt tokens
  completionTokens Int? // Completion tokens
  createdAt        DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("ai_assistant")
}

model PushToken {
  id         String    @id @default(cuid())
  userId     String?
  token      String    @unique
  deviceId   String?
  platform   String?
  appVersion String?
  enabled    Boolean   @default(true)
  lastUsedAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("push_tokens")
}

model NotificationPreference {
  id               String    @id @default(cuid())
  userId           String    @unique
  dailyPushEnabled Boolean   @default(false)
  dailyPushHour    Int       @default(8)
  timezone         String    @default("UTC")
  lastPushSentAt   DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notification_preferences")
}

model Article {
  id             String    @id @default(cuid())
  slug           String
  locale         String    @default("ru")
  title          String
  subtitle       String?   @map("subtitle")
  bodyMarkdown   String    @map("body_markdown") // Markdown content
  contentHtml    String?   @map("content_html") // Generated HTML (optional, for backward compatibility)
  excerpt        String?   @map("excerpt")
  heroImageUrl   String?   @map("hero_image_url") // Main hero image
  coverUrl       String?   @map("cover_url") // Legacy field (kept for backward compatibility)
  coverAlt       String?   @map("cover_alt")
  sourceName     String?   @map("source_name")
  sourceUrl      String?   @map("source_url")
  readingMinutes Int?      @map("reading_minutes")
  tags           String[]  // Array of tags
  isFeatured     Boolean   @default(false) @map("is_featured")
  isActive       Boolean   @default(true) @map("is_active") // Active status
  isPublished    Boolean   @default(true) @map("is_published") // Legacy field (kept for backward compatibility)
  authorId       String?   @map("author_id")
  viewCount      Int       @default(0) @map("view_count")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  publishedAt    DateTime? @map("published_at")

  @@unique([slug, locale])
  @@index([locale, isActive])
  @@index([isActive, isFeatured])
  @@index([tags])
  @@map("articles")
}

enum FoodSource {
  USDA_LOCAL
  USDA_API
}

model Food {
  id             String                   @id @default(uuid())
  fdcId          Int                      @unique @map("fdc_id")
  dataType       String                   @map("data_type")
  description    String
  brandOwner     String?                  @map("brand_owner")
  gtinUpc        String?                  @unique @map("gtin_upc")
  scientificName String?                  @map("scientific_name")
  publishedAt    DateTime?                @map("published_at")
  updatedAt      DateTime?                @map("updated_at")
  source         FoodSource               @default(USDA_LOCAL)
  createdAt      DateTime                 @default(now()) @map("created_at")
  updatedAtRow   DateTime                 @updatedAt @map("updated_at_row")
  searchVector   Unsupported("tsvector")? @map("search_vector")

  portions  FoodPortion[]
  nutrients FoodNutrient[]
  label     LabelNutrients?
  embedding FoodEmbedding?

  @@index([fdcId])
  @@index([dataType])
  @@index([description])
  @@map("foods")
}

model FoodPortion {
  id          String  @id @default(uuid())
  foodId      String  @map("food_id")
  gramWeight  Float   @map("gram_weight")
  measureUnit String  @map("measure_unit")
  modifier    String?
  amount      Float?
  food        Food    @relation(fields: [foodId], references: [id], onDelete: Cascade)

  @@index([foodId])
  @@map("food_portions")
}

model Nutrient {
  id       Int            @id // USDA nutrient.id
  number   String?
  name     String
  unitName String         @map("unit_name")
  rank     Int?
  foods    FoodNutrient[]

  @@map("nutrients")
}

model FoodNutrient {
  id         String   @id @default(uuid())
  foodId     String   @map("food_id")
  nutrientId Int      @map("nutrient_id")
  amount     Float
  food       Food     @relation(fields: [foodId], references: [id], onDelete: Cascade)
  nutrient   Nutrient @relation(fields: [nutrientId], references: [id], onDelete: Restrict)

  @@unique([foodId, nutrientId])
  @@index([foodId])
  @@index([nutrientId])
  @@map("food_nutrients")
}

model LabelNutrients {
  foodId        String @id @map("food_id")
  calories      Float?
  protein       Float?
  fat           Float?
  carbohydrates Float?
  fiber         Float?
  sugars        Float?
  sodium        Float?
  cholesterol   Float?
  potassium     Float?
  calcium       Float?
  iron          Float?
  food          Food   @relation(fields: [foodId], references: [id], onDelete: Cascade)

  @@map("label_nutrients")
}

model FoodEmbedding {
  foodId    String  @id @map("food_id")
  embedding Bytes // pgvector через Prisma: @db.Vector(1536), если включено; иначе хранить в Bytes и работать через сырой SQL
  doc       String
  ts        String? // tsvector через raw SQL индекс
  food      Food    @relation(fields: [foodId], references: [id], onDelete: Cascade)

  @@index([foodId])
  @@map("food_embeddings")
}
