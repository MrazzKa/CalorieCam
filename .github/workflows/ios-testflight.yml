name: "iOS - Build & Upload (Xcode 16.2)"

on:
  workflow_dispatch: {}

jobs:
  build-ios:
    runs-on: macos-14
    env:
      DEVELOPER_DIR: /Applications/Xcode_16.2.app/Contents/Developer
      APP_NAME: ${{ vars.APP_NAME || 'EatSense' }}
      SCHEME: ${{ vars.SCHEME || 'EatSense' }}
      BUNDLE_ID: ${{ vars.BUNDLE_ID || 'ch.eatsense.app' }}
      CI: "1"

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Enable corepack & install deps
        run: |
          set -euxo pipefail
          corepack enable
          pnpm config set node-linker hoisted
          pnpm config set shamefully-hoist true
          pnpm i --frozen-lockfile

      - name: Expo prebuild (iOS)
        run: |
          set -euxo pipefail
          npx --yes expo prebuild --platform ios --no-install
          cd ios && pod install --repo-update

      - name: Decode signing assets
        env:
          IOS_DIST_P12_BASE64: ${{ secrets.IOS_DIST_P12_BASE64 }}
          IOS_MOBILEPROV_BASE64: ${{ secrets.IOS_MOBILEPROV_BASE64 }}
        run: |
          set -euxo pipefail
          mkdir -p signing
          (printf "%s" "$IOS_DIST_P12_BASE64" | base64 -d > signing/dist.p12) || (printf "%s" "$IOS_DIST_P12_BASE64" | base64 -D > signing/dist.p12)
          (printf "%s" "$IOS_MOBILEPROV_BASE64" | base64 -d > signing/profile.mobileprovision) || (printf "%s" "$IOS_MOBILEPROV_BASE64" | base64 -D > signing/profile.mobileprovision)
          security cms -D -i signing/profile.mobileprovision >/dev/null

      - name: Create keychain & import cert
        env:
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
          IOS_DIST_P12_PASSWORD: ${{ secrets.IOS_DIST_P12_PASSWORD }}
        run: |
          set -euxo pipefail
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security set-keychain-settings -lut 21600 build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security import signing/dist.p12 -k build.keychain -P "$IOS_DIST_P12_PASSWORD" -A -f pkcs12
          security list-keychain -d user -s build.keychain login.keychain
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" build.keychain
          security find-identity -v -p codesigning

      - name: Install provisioning profile
        run: |
          set -euxo pipefail
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          UUID=$(/usr/libexec/PlistBuddy -c 'Print UUID' /dev/stdin <<< "$(security cms -D -i signing/profile.mobileprovision)")
          NAME=$(/usr/libexec/PlistBuddy -c 'Print Name' /dev/stdin <<< "$(security cms -D -i signing/profile.mobileprovision)")
          echo "Profile UUID: $UUID / Name: $NAME"
          cp signing/profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/$UUID.mobileprovision
          echo "PROFILE_UUID=$UUID" >> $GITHUB_ENV
          echo "IOS_PROFILE_NAME=$NAME" >> $GITHUB_ENV

      - name: Show build settings (debug aid)
        working-directory: ios
        run: |
          set -euxo pipefail
          xcodebuild -list -workspace "${APP_NAME}.xcworkspace"
          xcodebuild -showBuildSettings -workspace "${APP_NAME}.xcworkspace" -scheme "${SCHEME}" | grep -E "PRODUCT_BUNDLE_IDENTIFIER|DEVELOPMENT_TEAM|CODE_SIGN|PROVISIONING_PROFILE"

      - name: Prebundle React Native (iOS release)
        env:
          NODE_OPTIONS: --max-old-space-size=4096
        run: |
          set -euxo pipefail
          ENTRY="index.js"
          [ -f "index.ts" ] && ENTRY="index.ts"
          [ -f "index.tsx" ] && ENTRY="index.tsx"
          npx --yes react-native bundle \
            --platform ios \
            --dev false \
            --entry-file "$ENTRY" \
            --bundle-output ios/main.jsbundle \
            --assets-dest ios \
            --reset-cache \
            --verbose
          ls -lh ios/main.jsbundle

      - name: Build .xcarchive (Release)
        working-directory: ios
        env:
          DEVELOPMENT_TEAM: ${{ secrets.IOS_TEAM_ID }}
          SKIP_BUNDLING: "1"
        run: |
          set -euxo pipefail
          xcodebuild -workspace "${APP_NAME}.xcworkspace" \
            -scheme "${SCHEME}" \
            -configuration Release \
            -destination "generic/platform=iOS" \
            -sdk iphoneos \
            -archivePath "$RUNNER_TEMP/build/${SCHEME}.xcarchive" \
            PRODUCT_BUNDLE_IDENTIFIER="${BUNDLE_ID}" \
            DEVELOPMENT_TEAM="${DEVELOPMENT_TEAM}" \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGN_IDENTITY="Apple Distribution" \
            PROVISIONING_PROFILE_SPECIFIER="${IOS_PROFILE_NAME}" \
            PROVISIONING_PROFILE="${PROFILE_UUID}" \
            OTHER_CODE_SIGN_FLAGS="--keychain build.keychain" \
            clean archive | xcpretty
          ls -lah "$RUNNER_TEMP/build" || true
          /usr/libexec/PlistBuddy -c 'Print :ApplicationProperties:ApplicationPath' "$RUNNER_TEMP/build/${SCHEME}.xcarchive/Info.plist"

      - name: Export .ipa (app-store)
        run: |
          set -euxo pipefail
          cat > "$RUNNER_TEMP/exportOptions.plist" <<PLIST
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0"><dict>
            <key>method</key><string>app-store</string>
            <key>teamID</key><string>${{ secrets.IOS_TEAM_ID }}</string>
            <key>signingStyle</key><string>manual</string>
            <key>provisioningProfiles</key><dict>
              <key>${BUNDLE_ID}</key><string>${IOS_PROFILE_NAME}</string>
            </dict>
            <key>uploadSymbols</key><true/>
          </dict></plist>
          PLIST

          xcodebuild -exportArchive \
            -archivePath "$RUNNER_TEMP/build/${SCHEME}.xcarchive" \
            -exportOptionsPlist "$RUNNER_TEMP/exportOptions.plist" \
            -exportPath "$RUNNER_TEMP/export" \
            -allowProvisioningUpdates | xcpretty
          ls -lh "$RUNNER_TEMP/export"

      - name: Upload to TestFlight
        uses: apple-actions/upload-testflight-build@v1
        with:
          app-path: ${{ runner.temp }}/export/${{ env.SCHEME }}.ipa
          issuer-id: ${{ secrets.ASC_ISSUER_ID }}
          api-key-id: ${{ secrets.ASC_KEY_ID }}
          api-private-key: ${{ secrets.ASC_KEY_P8 }}
