name: iOS • Build & Upload to TestFlight (Xcode 16.2)

on:

  workflow_dispatch:

    inputs:

      build_number:

        description: 'CFBundleVersion (опц.)'

        required: false

  push:

    tags:

      - 'ios-v*'   # например, ios-v1.0.0+2

jobs:

  build-ios:

    runs-on: macos-14

    env:

      NODE_VERSION: '20'

      KEYCHAIN_PASSWORD: 'temp-keychain-pass-123' # одноразовый пароль для временного кейчейна

      BUNDLE_ID: ${{ vars.BUNDLE_ID }}

      SCHEME: ${{ vars.SCHEME }}

      APP_NAME: ${{ vars.APP_NAME }}

      EXPO_PUBLIC_ENV: ${{ vars.EXPO_PUBLIC_ENV }}

      EXPO_PUBLIC_API_BASE_URL: ${{ vars.EXPO_PUBLIC_API_BASE_URL }}

    steps:

      - name: Checkout

        uses: actions/checkout@v4

      - name: Set up Xcode 16.2

        uses: maxim-lobanov/setup-xcode@v1

        with:

          xcode-version: '16.2'

      - name: Set up Node

        uses: actions/setup-node@v4

        with:

          node-version: ${{ env.NODE_VERSION }}

      - name: Set up PNPM

        uses: pnpm/action-setup@v4

        with:

          version: 10.19.0

      - name: Install JS deps

        run: pnpm install --frozen-lockfile=false

      - name: Expo prebuild (iOS)

        run: npx expo prebuild --platform ios --no-install --non-interactive --clean

      - name: CocoaPods install

        working-directory: ios

        run: |

          pod install --repo-update

      - name: Decode signing assets

        shell: bash

        run: |

          echo "${IOS_DIST_P12_BASE64}" | base64 --decode > dist.p12

          echo "${IOS_MOBILEPROV_BASE64}" | base64 --decode > profile.mobileprovision

          PROFILE_UUID=$(/usr/libexec/PlistBuddy -c 'Print :UUID' /dev/stdin <<< "$(security cms -D -i profile.mobileprovision)")

          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"

          cp profile.mobileprovision "$HOME/Library/MobileDevice/Provisioning Profiles/${PROFILE_UUID}.mobileprovision"

          echo "PROFILE_UUID=$PROFILE_UUID" >> $GITHUB_ENV

        env:

          IOS_DIST_P12_BASE64: ${{ secrets.IOS_MOBILEPROV_BASE64 }}

          IOS_MOBILEPROV_BASE64: ${{ secrets.IOS_MOBILEPROV_BASE64 }}

      - name: Create & unlock keychain + import p12

        run: |

          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain

          security default-keychain -s build.keychain

          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain

          security import dist.p12 -k build.keychain -P "${IOS_DIST_P12_PASSWORD}" -T /usr/bin/codesign -T /usr/bin/security

          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" build.keychain

        env:

          IOS_DIST_P12_PASSWORD: ${{ secrets.IOS_DIST_P12_PASSWORD }}

      - name: Bump CFBundleVersion (optional)

        if: ${{ github.event.inputs.build_number != '' }}

        run: /usr/libexec/PlistBuddy -c "Set :CFBundleVersion ${GITHUB_INPUT}" "ios/${APP_NAME}/Info.plist"

        env:

          GITHUB_INPUT: ${{ github.event.inputs.build_number }}

      - name: Build .xcarchive (Release)

        run: |

          xcodebuild \

            -workspace "ios/${APP_NAME}.xcworkspace" \

            -scheme "${SCHEME}" \

            -configuration Release \

            -archivePath "$PWD/build/${APP_NAME}.xcarchive" \

            DEVELOPMENT_TEAM="${IOS_TEAM_ID}" \

            PRODUCT_BUNDLE_IDENTIFIER="${BUNDLE_ID}" \

            CODE_SIGN_STYLE=Manual \

            PROVISIONING_PROFILE_SPECIFIER="${PROFILE_UUID}" \

            clean archive | xcpretty

        env:

          IOS_TEAM_ID: ${{ secrets.IOS_TEAM_ID }}

      - name: Prepare ExportOptions.plist

        run: |

          cat > exportOptions.plist <<'PLIST'

          <?xml version="1.0" encoding="UTF-8"?>

          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">

          <plist version="1.0">

          <dict>

            <key>method</key><string>app-store</string>

            <key>signingStyle</key><string>manual</string>

            <key>teamID</key><string>${IOS_TEAM_ID}</string>

            <key>provisioningProfiles</key>

            <dict>

              <key>${BUNDLE_ID}</key><string>${PROFILE_UUID}</string>

            </dict>

            <key>stripSwiftSymbols</key><true/>

            <key>uploadSymbols</key><true/>

          </dict>

          </plist>

          PLIST

        env:

          IOS_TEAM_ID: ${{ secrets.IOS_TEAM_ID }}

      - name: Export .ipa

        run: |

          xcodebuild -exportArchive \

            -archivePath "$PWD/build/${APP_NAME}.xcarchive" \

            -exportPath "$PWD/build" \

            -exportOptionsPlist exportOptions.plist | xcpretty

      - name: Upload .ipa artifact

        uses: actions/upload-artifact@v4

        with:

          name: ios-ipa

          path: build/*.ipa

          if-no-files-found: error

      - name: Write ASC API key file

        run: |

          cat > /tmp/asc_key.json <<JSON

          {

            "key_id": "${ASC_KEY_ID}",

            "issuer_id": "${ASC_ISSUER_ID}",

            "key": "${ASC_KEY_P8}"

          }

          JSON

        env:

          ASC_KEY_ID: ${{ secrets.ASC_KEY_ID }}

          ASC_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}

          ASC_KEY_P8: ${{ secrets.ASC_KEY_P8 }}

      - name: Install fastlane

        run: gem install fastlane -N

      - name: Upload to TestFlight (pilot)

        run: |

          fastlane pilot upload \

            --api_key_path /tmp/asc_key.json \

            --ipa build/${APP_NAME}.ipa \

            --app_identifier "${BUNDLE_ID}" \

            --skip_waiting_for_build_processing true

